# chat-rag 性能测试工具

这个工具用于测试 chat-rag 服务的 `/v1/chat/completions` API 的性能，包括首token延时和总耗时。

使用Go语言实现，提供高效的并发性能测试功能。

## 功能特点

- 测量首token延时（从发送请求到收到第一个响应数据的时间）
- 测量总耗时（从发送请求到收到完整响应的时间）
- 支持并发测试，可控制并发数和总请求数
- 提供详细的性能统计信息（平均值、中位数、P95、P99等）
- 支持自定义请求参数
- 支持流式和非流式响应测试
- 自动添加必要的请求头（x-quota-identity和X-Request-ID）
- 实时显示请求进度和响应内容
- 显示每个请求的唯一ID

## 安装依赖

Go版本不需要额外依赖，只需要安装Go 1.21或更高版本。

## 使用方法

### 基本用法

```bash
go run test_chat_performance.go
```

或者使用批处理脚本：
```bash
run_go_performance_test.bat
```

默认参数：
- API地址: http://localhost:8888
- 并发数: 5
- 总请求数: 10
- 模型: gpt-4
- 测试消息: "请介绍一下Go语言的特点"
- 使用流式响应

### 自定义参数

```bash
go run test_chat_performance.go --url http://localhost:8888 --concurrency 10 --requests 50 --model "deepseek-v3" --message "解释什么是微服务架构"
```

### 参数说明

- `--url`: API服务地址 (默认: http://localhost:8888)
- `--concurrency`: 并发数 (默认: 5)
- `--requests`: 总请求数 (默认: 10)
- `--model`: 模型名称 (默认: gpt-4)
- `--message`: 测试消息内容 (默认: "请介绍一下Go语言的特点")
- `--stream`/`--no-stream`: 是否使用流式响应 (默认: 使用流式响应)
- `--custom-request`: 自定义请求JSON文件路径

### 使用自定义请求文件

创建一个JSON文件（例如 `custom_request.json`）：

```json
{
    "model": "deepseek-v3",
    "messages": [
        {"role": "system", "content": "你是一个专业的编程助手"},
        {"role": "user", "content": "请解释Go语言的协程机制"}
    ],
    "stream": true,
    "temperature": 0.5,
    "extra_body": {
        "prompt_mode": "performance"
    }
}
```

然后使用：

```bash
go run test_chat_performance.go --custom-request custom_request.json
```

## 输出示例

```
开始性能测试...
API地址: http://localhost:8888
并发数: 5
总请求数: 10
请求内容: 请介绍一下Go语言的特点
使用流式响应: True

请求 #1: 首token延时=0.245s, 总耗时=1.250s
请求 #2: 首token延时=0.231s, 总耗时=1.190s
...
请求 #10: 首token延时=0.277s, 总耗时=1.310s

测试完成，总耗时: 15.23 秒

============================================================
性能测试结果
============================================================
总请求数: 10
成功请求数: 10
失败请求数: 0
成功率: 100.00%

首token延时 (秒):
  平均值: 0.246
  中位数: 0.231
  最小值: 0.180
  最大值: 0.420
  P95: 0.380
  P99: 0.410

总耗时 (秒):
  平均值: 1.250
  中位数: 1.190
  最小值: 0.981
  最大值: 1.850
  P95: 1.651
  P99: 1.781
============================================================
```

## 注意事项

1. 确保 chat-rag 服务已启动并可访问
2. 根据服务性能调整并发数，避免过高并发导致服务不可用
3. 流式响应测试的首token延时是从发送请求到收到第一个数据块的时间
4. 非流式响应测试的首token延时与总耗时相同
5. 如果服务响应较慢，可能需要调整超时时间（在代码中修改）
6. 每个请求会自动添加以下请求头：
   - `x-quota-identity: system`
   - `X-Request-ID: [唯一标识符]` (每个请求自动生成不同的UUID)

## 性能指标说明

- **首token延时**: 用户感知的第一个响应时间，影响用户体验
- **总耗时**: 完整请求处理时间，反映系统整体性能
- **P95/P99**: 95%/99%的请求在这个时间内完成，用于评估性能稳定性
- **成功率**: 成功请求占总请求的比例，反映系统可靠性